# =============================================================================
# Azure DevOps CI/CD Pipeline for Snowflake
# =============================================================================
# This pipeline automates the deployment of Snowflake objects (tables, views,
# dynamic tables, etc.) across DEV and PROD environments.
#
# WORKFLOW:
#   - Feature branches → Deploy to DEV (automatic)
#   - Merge to main    → Deploy to PROD (requires approval)
#   - Manual trigger   → Reset DEV from PROD (zero-copy clone)
#
# AUTHENTICATION:
#   Uses RSA key pair authentication via a service user (CICD_SERVICE_USER).
#   The private key is stored base64-encoded in the SNOWFLAKE_PRIVATE_KEY
#   variable group to preserve newlines.
# =============================================================================

# Trigger on pushes to any branch, but only when SQL definitions or scripts change
trigger:
  branches:
    include:
      - '*'
  paths:
    include:
      - definitions/*
      - scripts/*

# Trigger on pull requests targeting main branch
pr:
  branches:
    include:
      - main

# Runtime parameters - these appear as options when manually running the pipeline
parameters:
- name: RESET_DEV
  displayName: 'Reset DEV from PROD?'
  type: boolean
  default: false

# Use self-hosted agent to bypass network policy IP restrictions
# Microsoft-hosted agents have dynamic IPs that can't be allowlisted
pool:
  name: 'Default'

# =============================================================================
# Variables
# =============================================================================
# SNOWFLAKE_PRIVATE_KEY is stored in a variable group (base64-encoded)
# Other connection details are defined inline
variables:
- group: SNOWFLAKE_CREDENTIALS

stages:
  # ===========================================================================
  # STAGE 1: Validate
  # ===========================================================================
  # Runs on every pipeline execution. Validates SQL files exist and tests
  # the Snowflake connection before attempting any deployments.
  - stage: Validate
    displayName: 'Validate SQL Syntax'
    jobs:
      - job: Validate
        displayName: 'Validate SQL Files'
        steps:
          - script: |
              pip3 install --user snowflake-cli jinja2
            displayName: 'Install Dependencies'

          # Configure Snowflake CLI with key pair authentication
          # The private key is base64-decoded to preserve newlines
          - script: |
              mkdir -p ~/.snowflake
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              mkdir -p ~/.snowflake/keys
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          - script: |
              echo "Validating SQL files..."
              for file in definitions/*.sql; do
                echo "Checking: $file"
                if [ -f "$file" ]; then
                  echo "  - File exists: OK"
                fi
              done
              echo "Validation complete!"
            displayName: 'Validate SQL Files Exist'

          # Verify we can connect to Snowflake before proceeding
          - script: |
              snow sql -q "SELECT CURRENT_ACCOUNT(), CURRENT_USER(), CURRENT_ROLE()" -c cicd
            displayName: 'Test Snowflake Connection'

  # ===========================================================================
  # STAGE 2: Deploy to DEV
  # ===========================================================================
  # Runs automatically on feature branches (non-main) when RESET_DEV is false.
  # Deploys all SQL definitions to the CICD_DEMO_DEV database.
  - stage: Deploy_DEV
    displayName: 'Deploy to DEV'
    dependsOn: Validate
    # Only run on feature branches (not main) and not during reset
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'), eq('${{ parameters.RESET_DEV }}', 'false'))
    jobs:
      - job: DeployDev
        displayName: 'Deploy to DEV Environment'
        steps:
          - script: |
              pip3 install --user snowflake-cli jinja2
            displayName: 'Install Dependencies'

          - script: |
              mkdir -p ~/.snowflake
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              mkdir -p ~/.snowflake/keys
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          # Run the deployment script targeting DEV environment
          - script: |
              python3 scripts/render_and_deploy.py DEV -c cicd
            displayName: 'Deploy to DEV'

  # ===========================================================================
  # STAGE 3: Deploy to PROD
  # ===========================================================================
  # Runs only on pushes to main branch (typically after PR merge).
  # Uses a deployment job with environment 'production' to enable approval gates.
  # Requires manual approval before execution (configured in Azure DevOps).
  - stage: Deploy_PROD
    displayName: 'Deploy to Production'
    dependsOn: Validate
    # Only run on main branch and not during reset
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq('${{ parameters.RESET_DEV }}', 'false'))
    jobs:
      # Using 'deployment' job type enables environment approvals and tracking
      - deployment: DeployProd
        displayName: 'Deploy to PROD'
        environment: 'production'  # Approval gate configured in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - script: |
                    pip3 install --user snowflake-cli jinja2
                  displayName: 'Install Dependencies'

                - script: |
                    mkdir -p ~/.snowflake
                    cat > ~/.snowflake/connections.toml << EOF
                    [cicd]
                    account = "$(SNOWFLAKE_ACCOUNT)"
                    user = "$(SNOWFLAKE_USER)"
                    authenticator = "SNOWFLAKE_JWT"
                    private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
                    warehouse = "$(SNOWFLAKE_WAREHOUSE)"
                    database = "$(SNOWFLAKE_DATABASE)"
                    role = "$(SNOWFLAKE_ROLE)"
                    EOF
                    chmod 0600 ~/.snowflake/connections.toml
                    mkdir -p ~/.snowflake/keys
                    echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
                    chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
                  displayName: 'Configure Snowflake Connection'
                  env:
                    SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

                # Run the deployment script targeting PROD environment
                - script: |
                    python3 scripts/render_and_deploy.py PROD -c cicd
                  displayName: 'Deploy to PROD'

                - script: |
                    echo "========================================"
                    echo "Deployment completed successfully!"
                    echo "Build ID: $(Build.BuildId)"
                    echo "Environment: PROD"
                    echo "========================================"
                  displayName: 'Deployment Summary'

  # ===========================================================================
  # STAGE 4: Reset DEV from PROD
  # ===========================================================================
  # Manual trigger only - used to reset DEV environment to match PROD.
  # Uses Snowflake zero-copy cloning for instant, storage-efficient reset.
  # To trigger: Run pipeline manually and set RESET_DEV = true
  - stage: Reset_DEV
    displayName: 'Reset DEV from PROD'
    dependsOn: Validate
    # Only run when RESET_DEV parameter is set to true
    condition: eq('${{ parameters.RESET_DEV }}', 'true')
    jobs:
      - job: ResetDev
        displayName: 'Clone PROD to DEV'
        steps:
          - script: |
              pip3 install --user snowflake-cli jinja2
            displayName: 'Install Dependencies'

          - script: |
              mkdir -p ~/.snowflake
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              mkdir -p ~/.snowflake/keys
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          # Zero-copy clone PROD to DEV, then redeploy to apply any DEV-specific config
          - script: |
              snow sql -q "CREATE OR REPLACE DATABASE CICD_DEMO_DEV CLONE CICD_DEMO_PROD" -c cicd
              python3 scripts/render_and_deploy.py DEV -c cicd
            displayName: 'Clone PROD to DEV and Redeploy'
