# =============================================================================
# Azure DevOps CI/CD Pipeline for Snowflake
# =============================================================================
# This pipeline automates deployment of Snowflake objects using snow git execute,
# which runs SQL directly from a Git repository connected to Snowflake.
#
# WORKFLOW:
#   - Feature branches -> Deploy to DEV (automatic)
#   - Merge to main    -> Deploy to PROD (requires approval)
#   - Manual trigger   -> Reset DEV from PROD (zero-copy clone)
#
# HOW IT WORKS:
#   1. Azure DevOps is the source of truth (remote Git repository)
#   2. Snowflake has a clone of the repo (SNOWFLAKE_DEVOPS_REPO)
#   3. snow git fetch syncs Snowflake's clone with Azure DevOps
#   4. snow git execute runs SQL files with Jinja templating
#
# AUTHENTICATION:
#   Uses RSA key pair authentication via a service user.
#   The private key is stored base64-encoded in the variable group.
# =============================================================================

# Trigger on pushes to any branch, but only when SQL definitions change
trigger:
  branches:
    include:
      - '*'
  paths:
    include:
      - definitions/*

# Trigger on pull requests targeting main branch
pr:
  branches:
    include:
      - main

# Runtime parameters - appear as options when manually running the pipeline
parameters:
- name: RESET_DEV
  displayName: 'Reset DEV from PROD?'
  type: boolean
  default: false

# Use self-hosted agent to bypass network policy IP restrictions
pool:
  name: 'Default'

# =============================================================================
# Variables - All stored in Azure DevOps variable group
# =============================================================================
variables:
- group: SNOWFLAKE_CREDENTIALS

# =============================================================================
# Reusable Templates
# =============================================================================
# Configure Snowflake CLI connection (used by all stages)
# Note: YAML anchors not supported in Azure Pipelines, so steps are repeated

stages:
  # ===========================================================================
  # STAGE 1: Validate
  # ===========================================================================
  # Tests Snowflake connection and syncs the Git repository
  - stage: Validate
    displayName: 'Validate Connection'
    jobs:
      - job: Validate
        displayName: 'Test Snowflake Connection'
        steps:
          - script: |
              pip3 install --user snowflake-cli
            displayName: 'Install Snowflake CLI'

          - script: |
              mkdir -p ~/.snowflake ~/.snowflake/keys
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          - script: |
              snow sql -q "SELECT CURRENT_ACCOUNT(), CURRENT_USER(), CURRENT_ROLE()" -c cicd
            displayName: 'Test Connection'

          # Sync Snowflake's Git repo clone with Azure DevOps
          - script: |
              snow git fetch CICD_DEMO_PROD.PUBLIC.SNOWFLAKE_DEVOPS_REPO -c cicd
            displayName: 'Sync Git Repository'

  # ===========================================================================
  # STAGE 2: Deploy to DEV
  # ===========================================================================
  # Runs on feature branches. Executes SQL with DEV environment variables.
  - stage: Deploy_DEV
    displayName: 'Deploy to DEV'
    dependsOn: Validate
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/main'), eq('${{ parameters.RESET_DEV }}', 'false'))
    jobs:
      - job: DeployDev
        displayName: 'Deploy to DEV Environment'
        steps:
          - script: |
              pip3 install --user snowflake-cli
            displayName: 'Install Snowflake CLI'

          - script: |
              mkdir -p ~/.snowflake ~/.snowflake/keys
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          # Execute SQL files from Git repo with DEV environment variables
          - script: |
              snow git execute "@CICD_DEMO_PROD.PUBLIC.SNOWFLAKE_DEVOPS_REPO/branches/$(Build.SourceBranchName)/definitions/*" \
                -D "env='DEV'" \
                -D "db_suffix='_DEV'" \
                -D "wh_size='X-SMALL'" \
                -c cicd
            displayName: 'Deploy to DEV'

  # ===========================================================================
  # STAGE 3: Deploy to PROD
  # ===========================================================================
  # Runs on main branch with approval gate. Executes SQL with PROD variables.
  - stage: Deploy_PROD
    displayName: 'Deploy to Production'
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq('${{ parameters.RESET_DEV }}', 'false'))
    jobs:
      - deployment: DeployProd
        displayName: 'Deploy to PROD'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    pip3 install --user snowflake-cli
                  displayName: 'Install Snowflake CLI'

                - script: |
                    mkdir -p ~/.snowflake ~/.snowflake/keys
                    cat > ~/.snowflake/connections.toml << EOF
                    [cicd]
                    account = "$(SNOWFLAKE_ACCOUNT)"
                    user = "$(SNOWFLAKE_USER)"
                    authenticator = "SNOWFLAKE_JWT"
                    private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
                    warehouse = "$(SNOWFLAKE_WAREHOUSE)"
                    database = "$(SNOWFLAKE_DATABASE)"
                    role = "$(SNOWFLAKE_ROLE)"
                    EOF
                    chmod 0600 ~/.snowflake/connections.toml
                    echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
                    chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
                  displayName: 'Configure Snowflake Connection'
                  env:
                    SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

                # Execute SQL files from Git repo with PROD environment variables
                - script: |
                    snow git execute "@CICD_DEMO_PROD.PUBLIC.SNOWFLAKE_DEVOPS_REPO/branches/main/definitions/*" \
                      -D "env='PROD'" \
                      -D "db_suffix='_PROD'" \
                      -D "wh_size='SMALL'" \
                      -c cicd
                  displayName: 'Deploy to PROD'

                - script: |
                    echo "========================================"
                    echo "Deployment completed successfully!"
                    echo "Build ID: $(Build.BuildId)"
                    echo "Environment: PROD"
                    echo "========================================"
                  displayName: 'Deployment Summary'

  # ===========================================================================
  # STAGE 4: Reset DEV from PROD
  # ===========================================================================
  # Manual trigger only. Clones PROD to DEV using zero-copy cloning.
  - stage: Reset_DEV
    displayName: 'Reset DEV from PROD'
    dependsOn: Validate
    condition: eq('${{ parameters.RESET_DEV }}', 'true')
    jobs:
      - job: ResetDev
        displayName: 'Clone PROD to DEV'
        steps:
          - script: |
              pip3 install --user snowflake-cli
            displayName: 'Install Snowflake CLI'

          - script: |
              mkdir -p ~/.snowflake ~/.snowflake/keys
              cat > ~/.snowflake/connections.toml << EOF
              [cicd]
              account = "$(SNOWFLAKE_ACCOUNT)"
              user = "$(SNOWFLAKE_USER)"
              authenticator = "SNOWFLAKE_JWT"
              private_key_path = "$HOME/.snowflake/keys/cicd_rsa.p8"
              warehouse = "$(SNOWFLAKE_WAREHOUSE)"
              database = "$(SNOWFLAKE_DATABASE)"
              role = "$(SNOWFLAKE_ROLE)"
              EOF
              chmod 0600 ~/.snowflake/connections.toml
              echo "$SNOWFLAKE_PRIVATE_KEY" | base64 -d > ~/.snowflake/keys/cicd_rsa.p8
              chmod 0600 ~/.snowflake/keys/cicd_rsa.p8
            displayName: 'Configure Snowflake Connection'
            env:
              SNOWFLAKE_PRIVATE_KEY: $(SNOWFLAKE_PRIVATE_KEY)

          # Zero-copy clone PROD to DEV, then redeploy DEV-specific config
          - script: |
              snow sql -q "CREATE OR REPLACE DATABASE CICD_DEMO_DEV CLONE CICD_DEMO_PROD" -c cicd
              snow git execute "@CICD_DEMO_PROD.PUBLIC.SNOWFLAKE_DEVOPS_REPO/branches/main/definitions/*" \
                -D "env='DEV'" \
                -D "db_suffix='_DEV'" \
                -D "wh_size='X-SMALL'" \
                -c cicd
            displayName: 'Clone PROD to DEV and Redeploy'
